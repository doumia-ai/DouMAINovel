"""内置小说类型初始化服务"""
import logging
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select
from app.models.genre import Genre

logger = logging.getLogger(__name__)

# 内置类型数据定义
BUILTIN_GENRES = [
    {
        "name": "玄幻",
        "description": "以超自然力量、异世界设定为核心的幻想类小说，通常包含修炼体系、神奇宝物、异能战斗等元素。",
        "world_building_guide": """世界观构建要点：
1. 设计独特的修炼体系（如：炼气、筑基、金丹、元婴等境界划分）
2. 构建完整的势力分布（宗门、家族、帝国等）
3. 设定天地法则和异能来源
4. 创造丰富的神器、丹药、阵法等设定
5. 规划不同区域的特色（如：东域、西域、南域、北域）""",
        "character_guide": """角色塑造要点：
1. 主角通常有特殊体质或机缘
2. 设计清晰的成长路线和目标
3. 配角要有各自的特色和立场
4. 反派要有合理的动机和实力
5. 注意角色间的羁绊和冲突""",
        "plot_guide": """情节设计要点：
1. 以主角修炼成长为主线
2. 穿插各种机缘和挑战
3. 设计层层递进的敌人和危机
4. 安排适当的爽点和高潮
5. 注意伏笔的埋设和回收""",
        "writing_style_guide": """写作风格建议：
1. 战斗场面要热血激昂
2. 修炼描写要有代入感
3. 对话要符合角色身份
4. 适当使用古风用语
5. 节奏要张弛有度""",
        "example_works": "《斗破苍穹》《武动乾坤》《大主宰》《完美世界》《遮天》",
        "keywords": ["修炼", "异能", "宗门", "境界", "神器", "丹药"],
        "sort_order": 1
    },
    {
        "name": "都市",
        "description": "以现代都市为背景的小说，描写都市生活、职场、商战、情感等内容。",
        "world_building_guide": """世界观构建要点：
1. 以现实都市为基础，可适当虚构城市
2. 设计合理的社会阶层和人际关系网
3. 构建真实的职场或商业环境
4. 注意时代背景和社会热点
5. 可融入轻微的超自然元素""",
        "character_guide": """角色塑造要点：
1. 主角要有鲜明的性格特点
2. 设计合理的人物背景和成长经历
3. 配角要有各自的生活和追求
4. 注意人物关系的复杂性
5. 角色要有成长和变化""",
        "plot_guide": """情节设计要点：
1. 以事业或情感为主线
2. 设计合理的冲突和转折
3. 注意生活细节的真实感
4. 安排适当的高潮和低谷
5. 结局要有满足感""",
        "writing_style_guide": """写作风格建议：
1. 语言要现代化、接地气
2. 对话要自然流畅
3. 描写要有画面感
4. 注意节奏的把控
5. 适当加入幽默元素""",
        "example_works": "《重生之神级学霸》《超级医生》《都市最强战神》",
        "keywords": ["现代", "职场", "商战", "情感", "逆袭", "重生"],
        "sort_order": 2
    },
    {
        "name": "历史",
        "description": "以历史时期为背景的小说，可以是架空历史或真实历史改编。",
        "world_building_guide": """世界观构建要点：
1. 选择具体的历史时期和地域
2. 研究该时期的政治、经济、文化
3. 了解当时的社会制度和风俗
4. 注意历史人物和事件的处理
5. 可适当架空但要保持合理性""",
        "character_guide": """角色塑造要点：
1. 角色言行要符合时代特征
2. 历史人物要有新的诠释
3. 原创角色要融入历史背景
4. 注意身份地位对角色的影响
5. 展现时代的局限和突破""",
        "plot_guide": """情节设计要点：
1. 以历史大事件为背景
2. 设计个人命运与时代的交织
3. 注意历史逻辑的合理性
4. 安排权谋、战争等精彩情节
5. 展现历史的厚重感""",
        "writing_style_guide": """写作风格建议：
1. 语言要有古典韵味
2. 描写要有历史质感
3. 对话要符合时代特征
4. 注意礼仪和称谓的准确
5. 适当引用诗词典故""",
        "example_works": "《庆余年》《赘婿》《唐砖》《明朝那些事儿》",
        "keywords": ["朝代", "权谋", "战争", "宫廷", "架空", "穿越"],
        "sort_order": 3
    },
    {
        "name": "科幻",
        "description": "以科学技术为基础的幻想小说，探索未来科技、宇宙探索、人工智能等主题。",
        "world_building_guide": """世界观构建要点：
1. 设定科技发展水平和时代背景
2. 构建合理的科技体系
3. 设计星际文明或未来社会
4. 注意科学原理的合理性
5. 探索科技对人类的影响""",
        "character_guide": """角色塑造要点：
1. 角色要适应科技环境
2. 展现人性在科技时代的变化
3. 设计有深度的AI角色
4. 注意不同文明的角色特点
5. 探索人与科技的关系""",
        "plot_guide": """情节设计要点：
1. 以科技发展或探索为主线
2. 设计科技带来的冲突和危机
3. 注意硬科幻的逻辑性
4. 安排宏大的宇宙场景
5. 探索哲学和伦理问题""",
        "writing_style_guide": """写作风格建议：
1. 科技描写要专业但易懂
2. 场景描写要有未来感
3. 对话要符合角色背景
4. 注意科学术语的使用
5. 保持想象力和逻辑性的平衡""",
        "example_works": "《三体》《流浪地球》《银河帝国》《星际穿越》",
        "keywords": ["未来", "宇宙", "AI", "星际", "科技", "末日"],
        "sort_order": 4
    },
    {
        "name": "武侠",
        "description": "以古代江湖为背景，描写侠客行侠仗义、快意恩仇的故事。",
        "world_building_guide": """世界观构建要点：
1. 构建江湖门派体系
2. 设计武功秘籍和武学体系
3. 规划江湖势力分布
4. 设定朝廷与江湖的关系
5. 创造独特的江湖规矩""",
        "character_guide": """角色塑造要点：
1. 主角要有侠义精神
2. 设计独特的武功和绝技
3. 配角要有江湖气息
4. 反派要有复杂的动机
5. 注意师徒、门派关系""",
        "plot_guide": """情节设计要点：
1. 以复仇、寻宝、争霸为主线
2. 设计精彩的武打场面
3. 安排江湖恩怨和情感纠葛
4. 注意伏笔和悬念
5. 展现侠义精神""",
        "writing_style_guide": """写作风格建议：
1. 语言要有古典武侠韵味
2. 武打描写要精彩传神
3. 对话要有江湖味道
4. 适当引用诗词歌赋
5. 注意节奏的快慢结合""",
        "example_works": "《射雕英雄传》《天龙八部》《笑傲江湖》《绝代双骄》",
        "keywords": ["江湖", "门派", "武功", "侠义", "恩仇", "秘籍"],
        "sort_order": 5
    },
    {
        "name": "仙侠",
        "description": "融合仙道修炼与侠义精神的小说，以修仙求道、飞升成仙为主题。",
        "world_building_guide": """世界观构建要点：
1. 设计完整的修仙体系
2. 构建仙界、人界、魔界等多重世界
3. 设定天道法则和因果轮回
4. 创造各种仙器、法宝、灵药
5. 规划宗门势力和仙界格局""",
        "character_guide": """角色塑造要点：
1. 主角要有求道之心
2. 设计独特的仙法和神通
3. 配角要有各自的道心和追求
4. 反派要有强大的实力和野心
5. 注意道侣、师徒关系""",
        "plot_guide": """情节设计要点：
1. 以修仙飞升为主线
2. 设计各种劫难和考验
3. 安排仙魔大战等宏大场面
4. 注意因果报应的设定
5. 探索道心和人性""",
        "writing_style_guide": """写作风格建议：
1. 语言要有仙气飘飘的感觉
2. 修炼描写要有意境
3. 战斗场面要恢弘大气
4. 适当使用道家术语
5. 注意仙凡之别的描写""",
        "example_works": "《凡人修仙传》《仙逆》《一念永恒》《诛仙》",
        "keywords": ["修仙", "飞升", "法宝", "劫难", "道心", "仙界"],
        "sort_order": 6
    },
    {
        "name": "奇幻",
        "description": "以西方魔法、精灵、龙族等元素为特色的幻想小说。",
        "world_building_guide": """世界观构建要点：
1. 设计魔法体系和规则
2. 构建多种族共存的世界
3. 设定神祇和信仰体系
4. 创造独特的地理和国家
5. 规划各种族的特点和关系""",
        "character_guide": """角色塑造要点：
1. 主角可以是各种种族
2. 设计独特的魔法能力
3. 配角要有种族特色
4. 反派要有宏大的野心
5. 注意种族间的文化差异""",
        "plot_guide": """情节设计要点：
1. 以冒险、战争、拯救为主线
2. 设计史诗级的战斗场面
3. 安排各种族的联盟与对抗
4. 注意魔法的合理使用
5. 展现宏大的世界观""",
        "writing_style_guide": """写作风格建议：
1. 描写要有西方奇幻风格
2. 魔法场面要华丽壮观
3. 对话要符合种族特点
4. 注意史诗感的营造
5. 适当使用西方神话元素""",
        "example_works": "《魔戒》《冰与火之歌》《哈利波特》《龙枪编年史》",
        "keywords": ["魔法", "精灵", "龙族", "冒险", "史诗", "种族"],
        "sort_order": 7
    },
    {
        "name": "悬疑",
        "description": "以推理、探案、解谜为核心的小说，注重逻辑推理和悬念设置。",
        "world_building_guide": """世界观构建要点：
1. 设定案件发生的时代背景
2. 构建合理的社会环境
3. 设计侦探或主角的工作环境
4. 注意法律和制度的设定
5. 可融入超自然元素""",
        "character_guide": """角色塑造要点：
1. 主角要有独特的推理能力
2. 设计有深度的嫌疑人
3. 配角要有各自的秘密
4. 反派要有高智商
5. 注意人物动机的合理性""",
        "plot_guide": """情节设计要点：
1. 以案件侦破为主线
2. 设计层层递进的线索
3. 安排合理的误导和反转
4. 注意逻辑的严密性
5. 结局要出人意料又合情合理""",
        "writing_style_guide": """写作风格建议：
1. 叙述要有悬念感
2. 线索要隐藏得当
3. 对话要暗藏玄机
4. 注意节奏的把控
5. 适当使用心理描写""",
        "example_works": "《福尔摩斯探案集》《东方快车谋杀案》《白夜行》《嫌疑人X的献身》",
        "keywords": ["推理", "探案", "悬念", "线索", "真相", "反转"],
        "sort_order": 8
    },
    {
        "name": "言情",
        "description": "以爱情为主题的小说，描写男女之间的情感故事。",
        "world_building_guide": """世界观构建要点：
1. 选择合适的时代背景
2. 设计男女主角的生活环境
3. 构建合理的社会关系网
4. 注意阶层和身份的设定
5. 可融入其他类型元素""",
        "character_guide": """角色塑造要点：
1. 男女主角要有吸引力
2. 设计合理的性格和背景
3. 配角要推动感情发展
4. 情敌要有存在感
5. 注意角色的成长变化""",
        "plot_guide": """情节设计要点：
1. 以感情发展为主线
2. 设计合理的相遇和误会
3. 安排甜蜜和虐心的情节
4. 注意感情的层次递进
5. 结局要有满足感""",
        "writing_style_guide": """写作风格建议：
1. 语言要细腻动人
2. 情感描写要真挚
3. 对话要有情趣
4. 注意氛围的营造
5. 适当使用心理描写""",
        "example_works": "《何以笙箫默》《微微一笑很倾城》《致我们终将逝去的青春》",
        "keywords": ["爱情", "甜蜜", "虐恋", "误会", "重逢", "HE"],
        "sort_order": 9
    },
    {
        "name": "修仙",
        "description": "以道家修炼成仙为核心的小说，强调修炼体系和境界突破。",
        "world_building_guide": """世界观构建要点：
1. 设计详细的修炼境界体系
2. 构建修真界的势力格局
3. 设定天地灵气和资源分布
4. 创造各种功法、丹药、法器
5. 规划凡界、修真界、仙界的关系""",
        "character_guide": """角色塑造要点：
1. 主角要有坚定的修炼意志
2. 设计独特的修炼资质和机缘
3. 配角要有各自的修炼之路
4. 反派要有强大的修为
5. 注意道侣、同门关系""",
        "plot_guide": """情节设计要点：
1. 以修炼突破为主线
2. 设计各种机缘和劫难
3. 安排宗门争斗和资源争夺
4. 注意境界提升的合理性
5. 展现修仙者的心境变化""",
        "writing_style_guide": """写作风格建议：
1. 修炼描写要有代入感
2. 战斗场面要精彩
3. 对话要符合修士身份
4. 适当使用道家术语
5. 注意修炼的枯燥与精彩的平衡""",
        "example_works": "《凡人修仙传》《修真聊天群》《我欲封天》《求魔》",
        "keywords": ["境界", "功法", "丹药", "法器", "渡劫", "飞升"],
        "sort_order": 10
    }
]


async def init_builtin_genres(db: AsyncSession) -> int:
    """
    初始化内置小说类型

    Args:
        db: 数据库会话

    Returns:
        新增的类型数量
    """
    created_count = 0

    for genre_data in BUILTIN_GENRES:
        # 检查是否已存在
        result = await db.execute(
            select(Genre).where(Genre.name == genre_data["name"])
        )
        existing = result.scalar_one_or_none()

        if existing:
            logger.debug(f"类型 '{genre_data['name']}' 已存在，跳过")
            continue

        # 创建新类型
        genre = Genre(
            name=genre_data["name"],
            description=genre_data["description"],
            is_builtin=True,
            world_building_guide=genre_data["world_building_guide"],
            character_guide=genre_data["character_guide"],
            plot_guide=genre_data["plot_guide"],
            writing_style_guide=genre_data["writing_style_guide"],
            example_works=genre_data["example_works"],
            keywords=genre_data["keywords"],
            sort_order=genre_data["sort_order"]
        )

        db.add(genre)
        created_count += 1
        logger.info(f"✅ 创建内置类型: {genre_data['name']}")

    if created_count > 0:
        await db.commit()
        logger.info(f"✅ 内置类型初始化完成，共创建 {created_count} 个类型")
    else:
        logger.info("内置类型已全部存在，无需初始化")

    return created_count
